> æœ¬æ–‡ä½œè€… [@zww](http://www.wenweizeng.com/)

DNSï¼ˆDomainNameSystemï¼‰åŸŸåç³»ç»Ÿï¼ˆæœåŠ¡ï¼‰åè®®

å®ƒæ˜¯åº”ç”¨å±‚åè®®ï¼Œä¸»è¦ç”¨äºåŸŸåä¸IPåœ°å€çš„ç›¸äº’è½¬æ¢ï¼Œä»¥åŠæ§åˆ¶å› ç‰¹ç½‘çš„ç”µå­é‚®ä»¶çš„å‘é€

å› ä¸ºåœ¨å•ä¸€DNSæœåŠ¡å™¨ä¸Šè¿è¡Œé›†ä¸­å¼æ•°æ®åº“å®Œå…¨æ²¡æœ‰å¯æ‰©å±•èƒ½åŠ›ã€‚å› æ­¤ï¼ŒDNSé‡‡ç”¨äº†åˆ†å¸ƒå¼çš„è®¾è®¡æ–¹æ¡ˆ

DNSéƒ¨åˆ†å±‚çº§ç»“æ„
![](img/dns/1.png)

DNS

å¤§è‡´è¯´æ¥ï¼Œæœ‰3ç§ç±»å‹çš„DNSæœåŠ¡å™¨:

- æ ¹DNSæœåŠ¡å™¨

- é¡¶çº§åŸŸ (Top-Level Domain, TLD)DNSæœåŠ¡å™¨

- æƒå¨ DNS æœåŠ¡å™¨ 

## DNSæŠ¥æ–‡

### DNSæŠ¥æ–‡æ ¼å¼

![](img/dns/2.png)

æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªå­—æ®µï¼š

- Flags

    - 1 bit "query/response"ï¼šæŠ¥æ–‡æ˜¯æŸ¥è¯¢æŠ¥æ–‡(0)è¿˜æ˜¯å›ç­”æŠ¥æ–‡(1) 

    - 1 bit "Recursion desired"ï¼šè¯¥DNSæœåŠ¡å™¨æ²¡æœ‰æŸè®°å½•æ—¶æ˜¯å¦å¸Œæœ›å®ƒæ‰§è¡Œé€’å½’æŸ¥è¯¢

    - 1 bit "Recursion available"ï¼šæ˜¯å¦æ”¯æŒé€’å½’æŸ¥è¯¢

- Questionsï¼šåŒ…å«æ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢ä¿¡æ¯

- Answersï¼šåŒ…å«å¯¹æœ€åˆè¯·æ±‚çš„åå­—çš„èµ„æºè®°å½•

- Authorityï¼šåŒ…å«å…¶ä»–æƒå¨æœåŠ¡å™¨çš„è®°å½•

- Additional informationï¼šåŒ…å«å…¶ä»–æœ‰å¸®åŠ©çš„è®°å½•

DNSåªæœ‰æŸ¥è¯¢å’Œå›ç­”æŠ¥æ–‡ä¸¤ç§ï¼Œå¹¶ä¸”ä»–ä»¬æ‹¥æœ‰ **ç›¸åŒçš„æ ¼å¼** 

## DNS Types
å…±åŒå®ç° DNS åˆ†å¸ƒå¼æ•°æ®åº“çš„æ‰€æœ‰DNSæœåŠ¡å™¨å­˜å‚¨äº†èµ„æºè®°å½• (Resource Record , RR)
èµ„æºè®°å½•æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸‹åˆ—å­—æ®µçš„ 4 å…ƒç»„:
(Name, Value, Type, TTL) 

- å¦‚æœ **Type=A** ï¼Œåˆ™Nameæ˜¯ä¸»æœºåï¼ŒValueæ˜¯è¯¥ä¸»æœºåå¯¹åº”çš„IPåœ°å€ã€‚å› æ­¤ï¼Œä¸€æ¡ç±»å‹ä¸ºAçš„èµ„æºè®°å½•æä¾›äº†æ ‡å‡†çš„ä¸»æœºååˆ°Fåœ°å€çš„æ˜ å°„ã€‚ä¾‹å¦‚(relay1.bar.foo.com,145.37.93.126,A)å°±æ˜¯ä¸€æ¡ç±»å‹Aè®°å½•

- å¦‚æœ **Type=NS** ï¼Œåˆ™Nameæ˜¯ä¸ªåŸŸ(å¦‚foo.com)ï¼Œè€ŒValueæ˜¯ä¸ªçŸ¥é“å¦‚ä½•è·å¾—è¯¥åŸŸä¸­ä¸»æœºEåœ°å€çš„æƒå¨DNSæœåŠ¡å™¨çš„ä¸»æœºåã€‚è¿™ä¸ªè®°å½•ç”¨äºæ²¿ç€æŸ¥è¯¢é“¾æ¥è·¯ç”±DNSæŸ¥è¯¢ã€‚ä¾‹å¦‚(f00.comï¼Œdns.foo.com,NS)å°±æ˜¯ä¸€æ¡ç±»å‹ä¸ºé—¸çš„è®°å½•

- å¦‚æœ **Type=CNAME** ï¼Œåˆ™Valueæ˜¯åˆ«åä¸ºNameçš„ä¸»æœºå¯¹åº”çš„è§„èŒƒä¸»æœºåã€‚è¯¥è®°å½•èƒ½å¤Ÿå‘æŸ¥è¯¢çš„ä¸»æœºæä¾›ä¸€ä¸ªä¸»æœºåå¯¹åº”çš„è§„èŒƒä¸»æœºåï¼Œä¾‹å¦‚(foo.com,CNAME)å°±æ˜¯ä¸€æ¡CNAMEç±»å‹çš„è®°å½•

- å¦‚æœ **Type=MX** ï¼Œåˆ™Valueæ˜¯ä¸ªåˆ«åä¸ºNameçš„é‚®ä»¶æœåŠ¡å™¨çš„è§„èŒƒä¸»æœºåã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ(foo.com,mail.foo.com,MX)å°±æ˜¯ä¸€æ¡MXè®°å½•ã€‚MXè®°å½•å…è®¸é‚®ä»¶æœåŠ¡å™¨ä¸»æœºåå…·æœ‰ç®€å•çš„åˆ«åã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡ä½¿ç”¨MXè®°å½•ï¼Œä¸€ä¸ªå…¬å¸çš„é‚®ä»¶æœåŠ¡å™¨å’Œå…¶ä»–æœåŠ¡å™¨(å¦‚å®ƒçš„WebæœåŠ¡å™¨)å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åˆ«åã€‚ä¸ºäº†è·å¾—é‚®ä»¶æœåŠ¡å™¨çš„è§„èŒƒä¸»æœºåï¼ŒDNSå®¢æˆ·åº”å½“è¯·æ±‚ä¸€æ¡MXè®°å½•;è€Œä¸ºäº†è·å¾—å…¶ä»–æœåŠ¡å™¨çš„è§„èŒƒä¸»æœºåï¼ŒDNSå®¢æˆ·åº”å½“è¯·æ±‚CNAMEè®°å½•


## WiresharkæŠ“åŒ…

åœ¨æŠ“å–dnsæŠ¥æ–‡æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ¸…ç†ä¸€ä¸‹æœ¬åœ°çš„dnsç¼“å­˜
``` sh
# mac
sudo killall -HUP mDNSResponder; sleep 2; echo macOS DNS Cache Reset | say
# windows
ipconfig /flushdns
```
åŒæ—¶ä¹Ÿè¦æ¸…ç†æµè§ˆå™¨çš„ç¼“å­˜å’Œæ•°æ®

æŸ¥çœ‹æœ¬æœºipåŠdnsæœåŠ¡å™¨
``` sh
# mac
## æŸ¥çœ‹ip
ifconfig
## æŸ¥çœ‹dnsæœåŠ¡å™¨
cat /etc/resolv.conf

# windows
ipconfig \all
```

ä½¿ç”¨nslookupä½œä¸ºæˆ‘ä»¬è¿½è¸ªdnsçš„å·¥å…·
``` sh
nslookup hnusec.group
```
wireshark è¿‡æ»¤è§„åˆ™
``` sh
ip.addr == Your IP && dns
```

### DNSæŸ¥è¯¢æŠ¥æ–‡

![](img/dns/3.png)

1. Flagsä¸­ç¬¬ä¸€ä½ä¸º0ï¼Œè¡¨ç¤ºquery
2. DNSåè®®è¿è¡Œåœ¨UDPä¹‹ä¸Šï¼Œä½¿ç”¨51486ç«¯å£å‘é€ï¼ˆè¿™ä¸ªå¯å˜ï¼‰ï¼Œ53å·ç«¯å£æ¥å—
3. æŸ¥è¯¢æŠ¥æ–‡ç”±æœ¬æœº192.168.3.89å‘é€ç»™æœ¬åœ°dnsæœåŠ¡å™¨192.168.3.1
4. DNSæŸ¥è¯¢æŠ¥æ–‡ä¸­æœ‰Transaction IDï¼š0x511eï¼ŒQueriesè¡¨æ˜è¦æŸ¥è¯¢çš„åŸŸåhnusec.groupï¼ˆType Aï¼‰

### DNSå›ç­”æŠ¥æ–‡

![](img/dns/4.png)

1. Flagsä¸­ç¬¬ä¸€ä½ä¸º1ï¼Œè¡¨ç¤ºresponse
2. 53ç«¯å£å‘é€ï¼Œ51486å·ç«¯å£æ¥å—ï¼ˆä¸ğŸ‘†DNSæŸ¥è¯¢æŠ¥æ–‡ç›¸å¯¹åº”ï¼‰
3. Queriesçš„å†…å®¹ä¸å¯¹åº”çš„æŸ¥è¯¢æŠ¥æ–‡ä¸­Queriesæ˜¯ç›¸åŒçš„ï¼ˆä¾‹å¦‚Transaction IDåŒä¸º0x511eï¼‰
4. Answersè¿”å›è¦æŸ¥è¯¢çš„åŸŸåhnusec.groupå¯¹åº”çš„ç±»å‹ï¼ˆType A)ï¼ŒIPåœ°å€ï¼ˆ39.100.94.176ï¼‰ä»¥åŠå…¶ä»–çš„ä¸€äº›å‚æ•°
5. Authoritative nameserversè¿”å›åŸŸåæ‰€å¯¹åº”çš„æƒå¨DNSæœåŠ¡å™¨ï¼ˆdns19.hichina.com, dns20.hichina.comï¼‰
![](img/dns/5.png)
ä¸åŸŸåè§£æä¸­åˆ†é…çš„DNSæœåŠ¡å™¨æ˜¯ä¸€è‡´çš„
5. Additional recordsä¼šè¿”å›ä¸€äº›å¸®åŠ©ä¿¡æ¯ï¼Œä¾‹å¦‚è¿™é‡Œå°±è¿”å›äº†è¿™äº›æƒå¨DNSæœåŠ¡å™¨å¯¹åº”çš„IPåœ°å€ï¼ˆä¸€ä¸ªåŸŸåå¯¹åº”å¤šä¸ªåœ°å€ï¼Œå‚è€ƒDNSè´Ÿè½½å‡è¡¡ï¼‰

åœ¨æŸ¥çœ‹Answersä¸­Nameå¯¹åº”çš„16è¿›åˆ¶æ•°æ®æ—¶ï¼Œå‘ç°å¹¶ä¸æ˜¯hnusec.groupï¼Œè€Œæ˜¯0xc00cï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢
![](img/dns/7.png)
[RFC 1035](https://tools.ietf.org/html/rfc1035)ä¸­çš„4.1.4.Message compressionåˆ™ç»™å‡ºäº†è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆ

>In order to reduce the size of messages, the domain system utilizes a compression scheme which eliminates the repetition of domain names in a message.  In this scheme, an entire domain name or a list of labels at the end of a domain name is replaced with a pointer to a prior occurance of the same name.

è¿™é‡Œä½¿ç”¨çš„æ˜¯DNSåè®®æ¶ˆæ¯å‹ç¼©æŠ€æœ¯ï¼Œä½¿ç”¨åç§»çš„æŒ‡é’ˆæ¥ä»£æ›¿é‡å¤çš„å­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚ä¸‹
```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
| 1  1|                OFFSET                   |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

æœ€å¼€å§‹çš„ä¸¤ä¸ªbitå¿…é¡»éƒ½ä¸º1ï¼Œç´§æ¥ç€14bitè¡¨ç¤ºå­—ç¬¦ä¸²åœ¨DNSæŠ¥æ–‡ä¸­çš„åç§»é‡ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯"hnusec.group"ï¼‰

ç”±äºDNSåº”ç­”åŒ…ä¸­çš„Answersæ®µå‡ºç°çš„åŸŸåå¾€å¾€åœ¨Queriesä¸­å·²ç»å‡ºç°ï¼Œå› æ­¤åé¢åªéœ€ä½¿ç”¨å…¶åç§»é‡è¡¨ç¤ºå³å¯ã€‚æ˜¾ç„¶ï¼ŒQueriesä¸­çš„åŸŸåå‡ºç°çš„é¢‘ç‡æœ€é«˜ï¼Œè€Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‡ºç°çš„åŸŸååç§»é‡å›ºå®šä¸º12å­—èŠ‚ï¼ˆ00001100ï¼‰ï¼ŒåŠ ä¸Šæœ€å¼€å§‹çš„ä¸¤ä¸ª1ï¼Œé‚£äºŒè¿›åˆ¶å°±æ˜¯
```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
| 1 1 | 0  0  0  0  0  0  0  0  0  0  1  1  0  0|
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```
å³0xC00Cã€‚ä»¥æ­¤ç±»æ¨ï¼Œå› æœ€å¼€å§‹å‡ºç°çš„å­—ç¬¦ä¸²éƒ½æ¯”è¾ƒé å‰ï¼Œå› æ­¤æŒ‡é’ˆå¤§å¤šä»¥â€œC0â€å¼€å¤´

å¦‚æœéœ€è¦æŒ‡å®šdns-serverï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å½¢å¼
``` sh
# nslookup domain [dns-server]
nslookup www.aiit.or.kr bitsy.mit.edu
```
![](img/dns/6.png)
å¯ä»¥çœ‹åˆ°ï¼Œå½“æŒ‡å®šä½¿ç”¨bitsy.mit.eduçš„dnsæœåŠ¡å™¨ï¼ˆ18.0.72.3ï¼‰åï¼Œnslookupé¦–å…ˆä¼šå»æœ¬åœ°dnsæœåŠ¡å™¨ä¸­å¯»æ‰¾æ˜¯å¦æœ‰bitsy.mit.eduçš„è®°å½•å¦‚æœæ²¡æœ‰ï¼Œåˆ™é¦–å…ˆä¼šå‘ä¸€æ¡å¯¹å…¶çš„dnsè¯·æ±‚

æ¥ç€ä½¿ç”¨è·å–åˆ°çš„bitsy.mit.eduçš„ipåœ°å€ä½œä¸ºdnsæœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ï¼ˆç¬¬42æ¡å·²ç»å°†18.0.72.3ä½œä¸ºç›®çš„åœ°ï¼‰

æœ€åè¿”å›www.aiit.or.krå¯¹äºçš„ipåœ°å€

## å‚è€ƒé“¾æ¥

* Computer Networking - A Top Down Approach, 7th, converted

* https://blog.csdn.net/xth21/article/details/104469241